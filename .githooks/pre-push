#!/bin/sh

# Pre-push hook to format code before pushing
# This hook will run PHP Pint and Prettier to format code

echo "ğŸ” Running code formatting before push..."

# Check if there are any PHP files that need formatting
if git diff --cached --name-only --diff-filter=ACM | grep -q '\.php$'; then
    echo "ğŸ“ Formatting PHP files with Pint..."
    if ! composer cs-fix; then
        echo "âŒ PHP formatting failed. Please fix the issues and try again."
        exit 1
    fi
    echo "âœ… PHP files formatted successfully"
fi

# Check if there are any JS/TS files that need formatting
if git diff --cached --name-only --diff-filter=ACM | grep -qE '\.(js|jsx|ts|tsx|vue|css|scss|json|md)$'; then
    echo "ğŸ“ Formatting JavaScript/TypeScript files with Prettier..."
    if ! npm run format; then
        echo "âŒ JavaScript/TypeScript formatting failed. Please fix the issues and try again."
        exit 1
    fi
    echo "âœ… JavaScript/TypeScript files formatted successfully"
fi

# Run linting checks
echo "ğŸ” Running linting checks..."

# PHP Static Analysis
if git diff --cached --name-only --diff-filter=ACM | grep -q '\.php$'; then
    echo "ğŸ” Running PHPStan analysis..."
    if ! composer analyze; then
        echo "âŒ PHPStan analysis failed. Please fix the issues and try again."
        exit 1
    fi
    echo "âœ… PHPStan analysis passed"
fi

# JavaScript/TypeScript linting
if git diff --cached --name-only --diff-filter=ACM | grep -qE '\.(js|jsx|ts|tsx)$'; then
    echo "ğŸ” Running ESLint..."
    if ! npm run lint; then
        echo "âŒ ESLint failed. Please fix the issues and try again."
        exit 1
    fi
    echo "âœ… ESLint passed"
fi

# TypeScript type checking
if git diff --cached --name-only --diff-filter=ACM | grep -qE '\.(ts|tsx)$'; then
    echo "ğŸ” Running TypeScript type checking..."
    if ! npm run types; then
        echo "âŒ TypeScript type checking failed. Please fix the issues and try again."
        exit 1
    fi
    echo "âœ… TypeScript type checking passed"
fi

echo "ğŸ‰ All formatting and linting checks passed! Proceeding with push..."
exit 0